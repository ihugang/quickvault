# MRZ 规范速查（ICAO Doc 9303）— 供代码实现参考

> 适用场景：护照/旅行证件/部分身份证件的 Machine Readable Zone（MRZ）OCR 解析与校验。
>
> 目标：为代码生成器（如 Codex）提供**可直接实现**的字段布局、校验算法与容错建议。

---

## 1. MRZ 基本概念

- **MRZ（Machine Readable Zone）**：证件上机器可读区，通常位于证件信息页底部。
- **用途**：高速录入身份信息；通过校验位降低录入错误。
- **强约束特征**：
  - **等宽字体**（OCR 友好，但反光/倾斜会显著影响）
  - **字符集受限**：仅允许 `A–Z`、`0–9`、`<`
  - **定长定格式**：不同证件类型对应固定行数与每行长度

---

## 2. 字符集与占位符

### 2.1 允许字符
- 字母：`A`–`Z`（必须大写）
- 数字：`0`–`9`
- 填充/分隔符：`<`

### 2.2 `<` 的语义
- **空格替代**：姓名等字段中空格用 `<` 表示
- **字段分隔**：例如姓与名之间用 `<<`
- **填充**：字段不足固定长度时用 `<` 填满

### 2.3 OCR 清洗建议（强烈推荐）
解析前应将 OCR 输出归一化：
1) 去除空格与换行
2) 转大写
3) 将非 `[A-Z0-9<]` 的字符替换为 `<`
4) 将常见误识别字符映射为目标字符（见 §9）

---

## 3. 三种常见 MRZ 格式

| 格式 | 行数 | 每行长度 | 常见证件 |
|---|---:|---:|---|
| **TD1** | 3 | 30 | 居留卡、部分身份证件 |
| **TD2** | 2 | 36 | 旧式旅行证件/部分证件 |
| **TD3** | 2 | 44 | **护照（含中国护照）** |

> 实现建议：优先支持 TD3（护照）与 TD1（居留卡/身份证件）。

---

## 4. TD3（护照）字段布局（2×44）

> 大多数护照（含中国护照）为 TD3。

### 4.1 Line 1（44 chars）

位置（1-based） | 长度 | 含义 | 备注
---|---:|---|---
1–2 | 2 | 文档类型 | 通常为 `P<`
3–5 | 3 | 签发国/组织代码 | 通常为 ISO 3166-1 alpha-3，如 `CHN`
6–44 | 39 | 姓名 | `SURNAME<<GIVEN<NAMES<<<<...` 不足补 `<`

**姓名规则**
- 姓与名用 `<<` 分隔
- 名中的空格用 `<` 替代
- 多个名用 `<` 分隔

**示例（伪）**
```
P<CHNZHANG<<SAN<<<<<<<<<<<<<<<<<<<<<<<<<<<
```

### 4.2 Line 2（44 chars）

位置（1-based） | 长度 | 含义 | 校验
---|---:|---|---
1–9 | 9 | 护照号码 | ✅ 校验位在 10
10 | 1 | 护照号码校验位 | ✅
11–13 | 3 | 国籍代码 |
14–19 | 6 | 出生日期（YYMMDD） | ✅ 校验位在 20
20 | 1 | 出生日期校验位 | ✅
21 | 1 | 性别 | `M` / `F` / `<`
22–27 | 6 | 到期日（YYMMDD） | ✅ 校验位在 28
28 | 1 | 到期日校验位 | ✅
29–42 | 14 | 个人号码（Personal number） | ⚠️ 部分国家为空（全 `<`）
43 | 1 | 个人号码校验位 | ⚠️ 若 personal 全 `<` 可弱化
44 | 1 | 复合校验位（Final check digit） | ✅

**复合校验位（Final check digit）**
- 用以下字段拼接后计算校验：
  - 护照号(1–9) + 护照号校验位(10)
  - 出生日期(14–19) + 出生校验位(20)
  - 到期日(22–27) + 到期校验位(28)
  - 个人号(29–42) + 个人号校验位(43)

**示例（伪）**
```
E12345678<CHN9001012M3001017<<<<<<<<<<<<<<04
```

---

## 5. TD1 字段布局（3×30）

> TD1 常见于居留证、部分身份证件。

### 5.1 Line 1（30）
- 1–2：文档类型
- 3–5：签发国/组织
- 6–14：文档号码
- 15：文档号码校验位
- 16–30：可选数据

### 5.2 Line 2（30）
- 1–6：出生日期（YYMMDD）
- 7：出生日期校验位
- 8：性别
- 9–14：到期日（YYMMDD）
- 15：到期日校验位
- 16–18：国籍
- 19–29：可选数据
- 30：可选数据校验位（部分实现）

### 5.3 Line 3（30）
- 姓名：`SURNAME<<GIVEN<NAMES...`（不足补 `<`）

> TD1 在不同国家的可选数据段位置可能变化；建议以 ICAO 9303 为准，或在产品中按证件模板定制。

---

## 6. TD2 字段布局（2×36）

> TD2 相对少见，字段与 TD3 类似但长度为 36。

- Line 1：文档类型、签发国、姓名
- Line 2：文档号、校验位、国籍、出生、校验位、性别、到期、校验位、可选数据、复合校验

> 若需要覆盖 TD2，推荐实现一个“通用解析器”并用长度（36 vs 44）分派。

---

## 7. 校验位算法（核心）

### 7.1 字符 → 数值映射
- 数字 `0–9`：值 = 0–9
- 字母 `A–Z`：`A=10, B=11, ... Z=35`
- `<`：值 = 0

### 7.2 权重循环
- 权重序列循环：`[7, 3, 1]`

### 7.3 计算公式
对字段字符串 `s[0..n-1]`：
1. `sum = Σ (value(s[i]) * weight[i mod 3])`
2. `checkDigit = sum mod 10`

### 7.4 校验通过条件
- 将计算得到的 `checkDigit` 与 MRZ 中给定校验位字符（数字）比较一致。

### 7.5 推荐校验策略
- **最低要求（MVP）**：校验 TD3 的护照号 / 出生 / 到期
- **推荐（更稳）**：加上 Final check digit（复合校验）
- **个人号码校验**：若 personal number 全 `<`，可视为通过或跳过

---

## 8. 解析与容错建议（生产实践）

### 8.1 解析顺序（护照 TD3）
1) 尝试定位并 OCR MRZ 区域
2) 按长度与字符集筛选候选行
3) 若拿到两行：按 TD3 固定位置切片
4) 进行校验位验证
5) 校验失败：进入容错修正（见 §9）或提示重拍/NFC

### 8.2 最常见 OCR 失败原因
- 第一行漏检（检测阶段过滤）
- `<` 被识别成 `I`/`|`/空格
- 数字/字母混淆（0/O、1/I、5/S…）
- 斜拍导致字符拉伸
- 反光导致对比不足

### 8.3 强烈推荐的 OCR 策略
- MRZ 单独裁剪 ROI（信息页底部约 25%–35%）
- **将 MRZ ROI 再拆成上下两条带分别识别**（显著提升第一行命中率）
- 关闭语言纠错：MRZ 不应启用 spell correction
- 仅使用英语：`en-US`

---

## 9. 常见误识别纠错表（仅在“数字字段/校验位字段”应用）

> 注意：姓名字段不要随意将 `O` 改 `0`，否则会误伤真实姓名拼写。

OCR 结果 | 纠正为
---|---
`O`, `Q` | `0`
`I`, `L` | `1`
`Z` | `2`
`S` | `5`
`B` | `8`
`G` | `6`
`‹`, `«`, `|` | `<`

**校验驱动纠错建议**
- 若某字段校验失败：仅对该字段内字符做替换尝试
- 尝试单字符替换后重新计算校验位，若通过则接受

---

## 10. 字段语义补充

### 10.1 日期（YYMMDD）世纪推断
MRZ 只给两位年份。推断策略：
- 若用于展示：可保留 `YYMMDD` 原样
- 若需转为 `YYYY-MM-DD`：
  - 以“到期日 vs 当前年份”做启发式：
    - 到期日通常在当前年份附近（未来 0–15 年）
    - 出生日期通常在过去（0–120 年）
  - 或让用户确认世纪

### 10.2 性别字段
- `M`：Male
- `F`：Female
- `<`：未指定/不可用

---

## 11. 示例（TD3）

> 示例为结构演示，非真实证件。

Line1（44）
```
P<CHNLI<<LEI<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
```
Line2（44）
```
E12345678<CHN9001012M3001017<<<<<<<<<<<<<<04
```

解析结果（示意）
- issuingCountry: CHN
- surname: LI
- givenNames: LEI
- passportNumber: E12345678
- nationality: CHN
- birth: 900101
- sex: M
- expiry: 300101

---

## 12. 实现清单（给 Codex 的任务拆解）

1. **预处理/清洗**：uppercase、去空格、过滤字符集、替换 `<` 变体
2. **格式识别**：按行数与长度判定 TD1/TD2/TD3
3. **字段切片**：按固定位置 substring
4. **校验位模块**：字符映射 + 权重 7/3/1 + mod 10
5. **容错修正**：仅数字字段做替换尝试，校验通过即接受
6. **输出模型**：统一结构（docType + fields + checksumsValid）

---

## 13. 备注
- 规范源头：ICAO Doc 9303（Machine Readable Travel Documents）
- 本文为工程实现速查；如需覆盖更多证件变体（如 TD1 可选字段差异），建议引入“国家/证件模板”配置层。

